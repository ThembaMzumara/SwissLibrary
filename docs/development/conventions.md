<!--
Copyright (c) 2024 Themba Mzumara
This file is part of SwissJS Framework. All rights reserved.
Licensed under the MIT License. See LICENSE in the project root for license information.
-->

# Developer Conventions

This repository follows strict conventions to ensure deterministic builds, clear public APIs, and consistent CI gating.

## Imports and ESM

- Use explicit `.js` extensions for all local imports and barrel re-exports.
- Prefer named exports only. Default exports are disallowed in `src/`.
- Public entrypoints must be re-exported through `src/index.ts` (barrel).

## Barrels

- Barrels must not re-export private internals from other packages.
- Wildcard re-exports are allowed only from your own package files.
- Deep imports into `@swissjs/*/src/*` are prohibited. Import from the package root.

## Public API Surface

- Public API is monitored by CI via generated TypeDoc JSON reflections.
- Any drift against baselines will fail CI. Update baselines only with intentional API changes.

### When to update API baselines

Update baselines only when you are making an intentional, reviewed change to the public surface of a package. Examples:

- Breaking or additive API changes (new exports, changed signatures, removed items)
- Deprecations that introduce staged aliases or shims
- Reorganizations that alter what `src/index.ts` re-exports

Do not update baselines for:

- Accidental exposure of internals (fix the barrel instead)
- Temporary or experimental symbols lacking review
- Non-functional refactors that should not change the public API

Process:

1. Make the API change and adjust docs/README examples accordingly.
2. Run `pnpm api:check` to confirm the expected drift.
3. If intentional, run `pnpm api:build` to refresh baselines in `etc/api/`.
4. Commit the code + docs + updated baselines with a clear message and rationale in the PR.
5. CI will pass once baselines reflect the new intended surface.

## Docs

- API docs are generated by an isolated runner (`tools/docs-runner/generate.mjs`).
- TypeScript and TypeDoc versions are pinned; Node version is pinned via `.nvmrc`.
- Docs must build deterministically (no timestamps/ordering diffs in outputs).

## Commit and Release Flow

- Use Changesets for all changes. Group related changes by package.
- Follow the preferred dev flow:
  1. Make changes
  2. Adjust documentation
  3. Commit
  4. Run `pnpm reset`
  5. Commit generated files
  6. Push

## CI Gates

- Lint and type-check must pass.
- Barrel compliance (`scripts/check-barrels.mjs`) must pass.
- Public API report must match baselines.
- Docs build must succeed.
- Markdown lint must pass.

## Testing

- Co-locate tests under `__tests__/` per package.
- Use Vitest; prefer fast, deterministic unit tests.

<!--
Copyright (c) 2024 Themba Mzumara
This file is part of SwissJS Framework. All rights reserved.
Licensed under the MIT License. See LICENSE in the project root for license information.
-->

# Release Process (Changesets)

This repo uses Changesets for versioning and publishing.

## TL;DR

- For any user-visible change, run:
  - `pnpm changeset` at repo root
  - Pick affected packages and change type (patch/minor/major)
  - Commit the generated file under `.changeset/`
- On `develop` branch, CI creates a version PR that bumps versions and changelogs.
- After merge, tag and publish run via CI when pushing a `vX.Y.Z` tag.

## Commands

- `pnpm changeset` – create a changeset
- `pnpm release:version` – apply changesets (updates package versions and CHANGELOGs)
- `pnpm release:publish` – publish all changed packages to npm

## CI Workflows

- `.github/workflows/changesets-version.yml`
  - On push to `develop`, creates or updates a version PR using Changesets.
- `.github/workflows/changesets-publish.yml`
  - On push to tags `v*.*.*`, builds and publishes to npm.
  - Requires `NPM_TOKEN` secret in repo settings.

## Conventions

- Use ticketed commit messages (e.g. `[SWS-CORE-123] ...`).
- Keep public barrels curated (no wildcards). CI will fail otherwise.
- Run the dev flow locally before pushing:
  1. Commit your changes
  2. `pnpm reset`
  3. Commit generated changes
  4. Push

## Notes

- Private packages are unaffected by publish.
- Internal dependency bumps are set to `patch` to keep the graph consistent.
- Base branch: `develop`.

---

## Full Release Flow (Authoritative)

### 1) Pre‑Release Validation (local)

- `pnpm reset` (curated, all‑in‑one validation)
  - clean → install → lint → type‑check → tests (CI=1) → policy checks → build → docs → markdownlint → tsdoc coverage
- API discipline
  - For baselines: `pnpm api:build` (writes/updates `etc/api/*.json`)
  - For checks only: `pnpm api:check`
- Docs
  - `pnpm docs:api && pnpm docs:api:index && pnpm docs:build`
  - TypeDoc is generated deterministically via `tools/docs-runner/generate.mjs` (JS API, cross‑platform)

### 2) Versioning with Changesets

- Author a changeset: `pnpm changeset`
  - Select affected packages (`packages/*`, `packages/plugins/*`, etc.)
  - Choose bump (patch/minor/major), add summary
- Apply versions: `pnpm release:version`
  - Updates package versions and CHANGELOGs
  - Commit and push to `develop`
- CI opens/updates the “Version Packages” PR (on `develop`). Ensure green.

### 3) Tag and Publish

- Merge the version PR per branch strategy (`develop → staging → release → main`)
- Create an annotated tag: `vX.Y.Z`
- Push tag to origin; CI workflow publishes to npm using `NPM_TOKEN`.

### 4) Post‑Release

- Create a GitHub Release
  - Link Changesets changelogs and `docs/RELEASE_NOTES.md`
  - Note known issues/caveats and next steps
- Open a new milestone for the next release/fix pack

### 5) Pre‑Releases (Optional, Recommended)

- Use Changesets pre mode for RC/canary:
  - `pnpm changeset pre enter rc` (or `canary`)
  - `pnpm release:version` then tag/publish with npm dist‑tag (e.g., `next`)
  - Exit pre mode with `pnpm changeset pre exit` before final release

---

## Bug Triage & Tracking (Minimum Standard)

- GitHub labels
  - `area:*` (core, cli, plugins, docs, devtools, vscode)
  - `type:*` (bug, feature, tech‑debt, docs)
  - `priority:*` (high, medium, low)
- Issue templates (bug/feature) require repro, env, expected vs actual
- PR template requires local `pnpm reset` and a Changeset for user‑visible changes
- Milestones per release/sprint (`Phase 6`, `6.1.0 Fix Pack`, etc.)

---

## Public Mirror (Authoritative)

- Purpose
  - The private `release` branch is mirrored to the public repo `main` via a clean export (no private CI or internal-only files).

- How it works
  - Workflow: `.github/workflows/mirror-to-public.yml`
  - Authentication: GitHub App token generated by `actions/create-github-app-token@v1` using `APP_ID` and `APP_PRIVATE_KEY` (PKCS#8) secrets.
  - Clean export: copies the repo to a `mirror/` directory while excluding:
    - `.git/`, `.github/workflows/`, `.github/ISSUE_TEMPLATE/`, `tools/`, `scripts/`, `etc/`, `docs/internal/`
  - A fresh git repo is created in `mirror/`, committed with an inline identity, and force-pushed to the public repo `main`.

- When it runs
  - On push to `release`
  - Manual: Actions → "Mirror to Public Repo" → Run workflow
  - Scheduled daily at 06:00 UTC

- Configure the target
  - Preferred: set `PUBLIC_REPO` secret (e.g., `ThembaMzumara/SwissLibrary`)
  - Alternate: set `PUBLIC_OWNER` and `PUBLIC_REPO_NAME` secrets

- Secrets required
  - `APP_ID` (GitHub App ID)
  - `APP_PRIVATE_KEY` (PKCS#8 format; begins with `-----BEGIN PRIVATE KEY-----`)
  - `PUBLIC_REPO` or (`PUBLIC_OWNER` + `PUBLIC_REPO_NAME`)

- Notes
  - Workflows are intentionally not mirrored to the public repo. If needed later, grant the App `Workflows: Read & write` on the public repo and remove the excludes.
